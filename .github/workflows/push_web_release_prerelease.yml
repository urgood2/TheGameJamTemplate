name: Build & Publish to itch.io

on:
  push:
    branches:
      - "**"   # build on all branches
  workflow_dispatch:  # Allow manual trigger

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  ITCH_PROJECT: chugget/testing

jobs:
  # ───────────────────────────────
  #  Native build (TEMPORARILY DISABLED)
  # ───────────────────────────────
  build-native:
    if: false          # <── DISABLE native job cleanly
    name: Build Native (Linux)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              build-essential cmake \
              libx11-dev libasound2-dev libudev-dev \
              libxrandr-dev libxi-dev libxinerama-dev libxcursor-dev \
              libgl1-mesa-dev \
              libgl-dev \
              mesa-common-dev

      - name: Configure CMake
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build
        run: cmake --build build --config Release

      - name: Package native build
        run: |
          mkdir -p dist/native/linux
          cp build/* dist/native/linux/ || true
          cp -R assets dist/native/linux/

      - name: Upload native build (v4)
        uses: actions/upload-artifact@v4
        with:
          name: native-linux
          path: dist/native/linux
          compression-level: 0


  # ───────────────────────────────
  #  Web build (ALWAYS RUNS)
  # ───────────────────────────────
  build-web:
    name: Build Web (Emscripten WASM)
    runs-on: ubuntu-24.04
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[build]') ||
      contains(github.event.head_commit.message, '[web]') ||
      contains(github.event.head_commit.message, '#build')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: 3.1.67
          actions-cache-folder: "emsdk-cache"

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: build-web/_deps
          key: web-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            web-deps-

      - name: Configure CMake (Web)
        run: |
          emcmake cmake -S . -B build-web \
            -DPLATFORM=Web \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_LTO=OFF

      - name: Copy assets to build directory
        run: |
          mkdir -p build-web/assets
          rsync -av --exclude='auto_export_assets.aseprite' \
                    --exclude='auto_export_assets-test.png' \
                    --exclude='graphics/atlas/' \
                    --exclude='graphics/ascii_tilesets/' \
                    --exclude='graphics/auto-exported-sprites-from-aseprite/' \
                    --exclude='graphics/pre-packing-files_globbed/' \
                    --exclude='localization/localization.babel' \
                    --exclude='scripts/AI_TABLE_CONTENT_EXAMPLE.lua' \
                    --exclude='scripts_archived/' \
                    --exclude='shaders/archived/' \
                    --exclude='siralim_data/' \
                    --exclude='test_features.ldtk' \
                    --exclude='test_translation_project.babel' \
                    --exclude='test.png' \
                    --exclude='Title.png' \
                    --exclude='Typical_2D_platformer_example.ldtk' \
                    --exclude='Typical_TopDown_example.ldtk' \
                    --exclude='*.babel' \
                    --exclude='*.ldtk' \
                    --exclude='*.tps' \
                    --exclude='*.aseprite' \
                    assets/ build-web/assets/
          echo "Assets size after exclusions:"
          du -sh build-web/assets/

      - name: Build Web
        timeout-minutes: 90
        env:
          # Limit Node.js memory to leave room for linker
          NODE_OPTIONS: "--max-old-space-size=2048"
        run: |
          # Build with single thread to minimize memory usage during linking
          # Use cmake --build for generator-agnostic builds
          cmake --build build-web -j1 --verbose

      - name: Rename to index.html
        run: |
          # Match justfile rename-to-index step
          cp build-web/raylib-cpp-cmake-template.html build-web/index.html
          echo "=== Renamed to index.html ==="

      - name: Inject pako gzip snippet
        run: |
          # Match justfile inject-web-snippet step
          cmake \
            -DHTML_PATH="build-web/index.html" \
            -DSNIPPET_PATH="cmake/inject_snippet.html" \
            -P cmake/inject_snippet.cmake
          echo "=== Pako snippet injected ==="

      - name: Gzip wasm and data files
        run: |
          # Match justfile gzip-web-assets step
          WASM_FILE="build-web/raylib-cpp-cmake-template.wasm"
          DATA_FILE="build-web/raylib-cpp-cmake-template.data"

          # Keep originals as backup
          cp "$WASM_FILE" "$WASM_FILE.orig"
          cp "$DATA_FILE" "$DATA_FILE.orig"

          # Gzip with -k (keep original) and -f (force)
          gzip -kf "$WASM_FILE"
          gzip -kf "$DATA_FILE"

          # Show size reduction
          echo "=== Gzip compression results ==="
          echo "WASM: $(stat --printf='%s' $WASM_FILE.orig) → $(stat --printf='%s' $WASM_FILE.gz) bytes"
          echo "DATA: $(stat --printf='%s' $DATA_FILE.orig) → $(stat --printf='%s' $DATA_FILE.gz) bytes"

      - name: Package Web build
        run: |
          # Match justfile zip-web-build step - files at root, not in subdirectory
          mkdir -p dist
          cd build-web
          zip -r ../dist/web-build.zip \
            index.html \
            raylib-cpp-cmake-template.wasm.gz \
            raylib-cpp-cmake-template.data.gz \
            raylib-cpp-cmake-template.js \
            assets
          cd ..
          echo "=== Zip created: dist/web-build.zip ($(du -h dist/web-build.zip | cut -f1)) ==="

      - name: Upload web build (v4)
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/web-build.zip
          compression-level: 0


  # ───────────────────────────────
  #  Publish JOB (only depends on WEB now)
  # ───────────────────────────────
  publish:
    name: Publish to itch.io
    needs: [ build-web ]         # <── removed native dependency
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Native disabled → skip download
      # - name: Download native build
      #   uses: actions/download-artifact@v4
      #   with:
      #     name: native-linux
      #     path: native

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web

      - name: Setup Butler
        uses: jdno/setup-butler@v1
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}

      - name: Determine itch channel
        id: channel
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" ]]; then
            echo "channel=web" >> $GITHUB_OUTPUT
          else
            echo "channel=web-dev" >> $GITHUB_OUTPUT
          fi

      - name: Version string
        id: version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            echo "version=build-${GITHUB_SHA}" >> $GITHUB_OUTPUT
          fi

      # Native publish disabled
      # - name: Publish native build
      #   run: |
      #     butler push native \
      #       ${{ env.ITCH_PROJECT }}:linux \
      #       --userversion ${{ steps.version.outputs.version }}

      - name: Publish web build
        run: |
          butler push web/web-build.zip \
            ${{ env.ITCH_PROJECT }}:${{ steps.channel.outputs.channel }} \
            --userversion ${{ steps.version.outputs.version }}
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
