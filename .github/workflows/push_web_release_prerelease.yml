name: Build & Publish to itch.io

on:
  push:
    branches:
      - "**"   # build on all branches

env:
  ITCH_PROJECT: chugget/testing
  EMSDK_VERSION: "3.1.67"

jobs:
  # ───────────────────────────────
  #  Native build (TEMPORARILY DISABLED)
  # ───────────────────────────────
  build-native:
    if: false          # <── DISABLE native job cleanly
    name: Build Native (Linux)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          lfs: true

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
              build-essential cmake \
              libx11-dev libasound2-dev libudev-dev \
              libxrandr-dev libxi-dev libxinerama-dev libxcursor-dev \
              libgl1-mesa-dev \
              libgl-dev \
              mesa-common-dev

      - name: Configure CMake
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build
        run: cmake --build build --config Release

      - name: Package native build
        run: |
          mkdir -p dist/native/linux
          cp build/* dist/native/linux/ || true
          cp -R assets dist/native/linux/

      - name: Upload native build (v4)
        uses: actions/upload-artifact@v4
        with:
          name: native-linux
          path: dist/native/linux
          compression-level: 0


  # ───────────────────────────────
  #  Web build (ALWAYS RUNS)
  # ───────────────────────────────
  build-web:
    name: Build Web (Emscripten WASM)
    runs-on: ubuntu-latest
    if: |
      contains(github.event.head_commit.message, '[build]') ||
      contains(github.event.head_commit.message, '[web]') ||
      contains(github.event.head_commit.message, '#build')

    steps:
      - uses: actions/checkout@v3

      - name: Setup Emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: ${{ env.EMSDK_VERSION }}
          actions-cache-folder: "emsdk-cache"

      - name: Export EMSDK paths for helper targets
        run: |
          echo "EMSDK_PATH=${EMSDK}" >> "$GITHUB_ENV"
          echo "EMSCRIPTEN_PATH=${EMSDK}/upstream/emscripten" >> "$GITHUB_ENV"

      # Cache CMake build dependencies
      - name: Cache CMake dependencies
        uses: actions/cache@v4
        with:
          path: |
            build-web/_deps
          key: cmake-deps-web-${{ runner.os }}-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            cmake-deps-web-${{ runner.os }}-

      - name: Configure CMake (Web)
        run: |
          emcmake cmake -S . -B build-web \
            -DPLATFORM=Web \
            -DCMAKE_BUILD_TYPE=Release \
            -DWEB_BUILD_DIR="${{ github.workspace }}/build-web" \
            -DITCH_BUILD_ID="${{ github.sha }}"

      - name: Copy assets into web build tree
        run: cmake --build build-web --target copy_assets

      - name: Build Web
        run: emmake make -C build-web -j$(nproc)

      - name: Run web helper targets (rename->index, inject snippet, gzip)
        run: |
          cmake --build build-web --target rename_to_index
          cmake --build build-web --target inject_web_patch
          cmake --build build-web --target gzip_assets

      - name: Package Web build
        run: |
          mkdir -p dist/web

          # Locate the generated html (raylib-cpp-cmake-template.html) and copy it as index.html
          HTML_FILE=$(ls build-web/*.html | head -n 1)
          if [ -z "$HTML_FILE" ]; then
            echo "No HTML output found in build-web/"
            exit 1
          fi
          cp "$HTML_FILE" dist/web/index.html

          # Copy main build outputs
          cp build-web/*.js dist/web/

          # Copy pre-gzipped wasm/data produced by helper targets
          for f in build-web/*.wasm.gz build-web/*.data.gz; do
            if [ -f "$f" ]; then
              cp "$f" dist/web/
            fi
          done

          # Optional: copy splash/favicon to root (tiny files)
          for f in assets/splash.png assets/favicon.png; do
            if [ -f "$f" ]; then
              cp "$f" dist/web/
            fi
          done

          # Copy splash.png to root if it exists in assets
          if [ -f "assets/splash.png" ]; then
            cp assets/splash.png dist/web/
          fi

          # Copy favicon if it exists
          if [ -f "assets/favicon.png" ]; then
            cp assets/favicon.png dist/web/
          fi

          # Create build info file
          echo "{\"build_id\": \"${{ github.sha }}\", \"build_time\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"branch\": \"${{ github.ref_name }}\"}" > dist/web/build_info.json

          # List final package contents
          echo "=== Package Contents ==="
          ls -lah dist/web/
          echo "=== Total Size ==="
          du -sh dist/web/

          # Create zip
          cd dist && zip -r web-build.zip web/

      - name: Upload web build (v4)
        uses: actions/upload-artifact@v4
        with:
          name: web-build
          path: dist/web-build.zip
          compression-level: 0
          retention-days: 14


  # ───────────────────────────────
  #  Publish JOB (only depends on WEB now)
  # ───────────────────────────────
  publish:
    name: Publish to itch.io
    needs: [ build-web ]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Download web build
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: web

      - name: Setup Butler
        uses: jdno/setup-butler@v1
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}

      - name: Determine itch channel
        id: channel
        run: |
          if [[ "${GITHUB_REF_NAME}" == "main" || "${GITHUB_REF_NAME}" == "master" ]]; then
            echo "channel=web" >> $GITHUB_OUTPUT
          else
            echo "channel=web-dev" >> $GITHUB_OUTPUT
          fi

      - name: Version string
        id: version
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            # Use short SHA for cleaner version display
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-8)
            echo "version=build-${SHORT_SHA}" >> $GITHUB_OUTPUT
          fi

      - name: Publish web build
        run: |
          echo "Publishing to ${{ env.ITCH_PROJECT }}:${{ steps.channel.outputs.channel }}"
          echo "Version: ${{ steps.version.outputs.version }}"

          butler push web/web-build.zip \
            ${{ env.ITCH_PROJECT }}:${{ steps.channel.outputs.channel }} \
            --userversion ${{ steps.version.outputs.version }}

          echo "::notice title=Published::Successfully published to itch.io (${{ steps.channel.outputs.channel }} channel)"
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}

      - name: Create deployment summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Project | ${{ env.ITCH_PROJECT }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Channel | ${{ steps.channel.outputs.channel }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version | ${{ steps.version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View your game at: https://${{ env.ITCH_PROJECT }}.itch.io" >> $GITHUB_STEP_SUMMARY
