name: Bargain MVP

on:
  push:
  pull_request:

jobs:
  # Build the game binary for headless tests
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev libpulse-dev libx11-dev libxext-dev libxrandr-dev \
            libxi-dev libxinerama-dev libxcursor-dev libglu1-mesa-dev libgl1-mesa-dev \
            libdrm-dev libgbm-dev libxkbcommon-dev \
            just

      - name: Configure
        run: cmake -B build-debug -DCMAKE_BUILD_TYPE=Debug -DENABLE_UNIT_TESTS=OFF

      - name: Build
        run: cmake --build build-debug --target raylib-cpp-cmake-template -j4

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: bargain-build
          path: build-debug/raylib-cpp-cmake-template
          retention-days: 1

  # Run Bargain headless tests
  test:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: bargain-build
          path: build-debug

      - name: Make binary executable
        run: chmod +x build-debug/raylib-cpp-cmake-template

      - name: Run Bargain headless tests
        run: |
          set -o pipefail
          RUN_BARGAIN_TESTS=1 ./build-debug/raylib-cpp-cmake-template | tee bargain-test-output.txt

      - name: Extract repro JSON
        if: failure()
        run: |
          grep -E '^{.*}$' bargain-test-output.txt | tail -n 1 > bargain-repro.json || true

      - name: Upload repro JSON
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: bargain-repro
          path: bargain-repro.json
          retention-days: 7
