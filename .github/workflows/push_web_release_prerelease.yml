name: Build & Publish to itch.io

on:
  push:
    branches:
      - '**'

env:
  ITCH_PROJECT: chugget/testing
  VERSION: ${{ github.sha }}   # fallback version for branch pushes

jobs:
  build-native:
    name: Build Native (Linux)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake libx11-dev libasound2-dev libudev-dev

      - name: Configure CMake
        run: |
          mkdir build && cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build
        run: |
          cmake --build build --config Release

      - name: Package native build
        run: |
          mkdir -p dist/native/linux
          cp -R build/bin/* dist/native/linux/
          cp -R assets dist/native/linux/

      - name: Upload native artifact
      - uses: actions/upload-artifact@v4
        with:
          name: native-build
          path: dist/native/linux
          compression-level: 0

  build-web:
    name: Build Web (WASM)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install Emscripten SDK
        run: |
          git clone https://github.com/emscripten-core/emsdk.git
          cd emsdk
          ./emsdk install latest
          ./emsdk activate latest
          echo "source $PWD/emsdk_env.sh" >> $GITHUB_ENV

      - name: Configure CMake (Web)
        run: |
          source $GITHUB_ENV
          mkdir build-web && cd build-web
          emcmake cmake -DPLATFORM=Web -DCMAKE_BUILD_TYPE=Release ../

      - name: Build Web
        run: |
          source $GITHUB_ENV
          emmake make -C build-web -j

      - name: Package Web build
        run: |
          mkdir -p dist/web
          cp build-web/index.html dist/web/
          cp build-web/*.wasm dist/web/
          cp build-web/*.js dist/web/
          cp -R assets dist/web/
          cd dist && zip -r web-build.zip web

      - name: Upload web artifact
        uses: actions/upload-artifact@v3
        with:
          name: web-build
          path: dist/web-build.zip

  publish:
    name: Publish to itch.io
    needs: [ build-native, build-web ]
    runs-on: ubuntu-latest
    steps:
      - name: Download native artifacts
        uses: actions/download-artifact@v3
        with:
          name: native-build
          path: native

      - name: Download web artifacts
        uses: actions/download-artifact@v3
        with:
          name: web-build
          path: web

      - name: Setup Butler
        uses: jdno/setup-butler@v1

      - name: Upload Native
        run: |
          butler push native ${{ env.ITCH_PROJECT }}:linux --userversion ${{ env.VERSION }}
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}

      - name: Upload Web
        run: |
          butler push web/web-build.zip ${{ env.ITCH_PROJECT }}:web --userversion ${{ env.VERSION }}
        env:
          BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
