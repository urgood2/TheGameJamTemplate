# Pixquare iPad Sync Pipeline Design

## Overview

Extend the existing sprite/animation auto-export pipeline to support creating pixel art on iPad using Pixquare, with automatic sync to the Mac-based Aseprite workflow.

## Goals

- Create/edit pixel art on iPad in Pixquare
- Seamlessly sync to Mac via iCloud Drive
- Integrate with existing Aseprite-based export pipelines
- Minimal manual intervention after initial export

## Folder Structure

### iCloud Folders (created once by user)

```
~/Library/Mobile Documents/com~apple~CloudDocs/
├── pixquare-animations/          ← Export animations here (.aseprite)
│   └── processed/                ← Moved here after processing
└── pixquare-sprites/             ← Export static sprites here (.aseprite)
    └── processed/                ← Moved here after processing
```

### Project Folders

```
assets/
├── animations/                   ← Animation .aseprite files (existing)
│   └── *.aseprite                ← New files copied here from iCloud
├── auto_export_assets.aseprite   ← Static sprites as layers (existing)
└── graphics/
    └── animations.json           ← Generated by export_animations.py (existing)
```

## Workflow

### Animation Workflow

**Trigger:** New or modified `.aseprite` file in `pixquare-animations/`

```
pixquare-animations/goblin_walk.aseprite
         │
         ▼
    [watch_pixquare.py]
         │
         ├── Copy to assets/animations/goblin_walk.aseprite (overwrites)
         ├── Move original to pixquare-animations/processed/
         ├── Notify: "Animation 'goblin_walk' synced from Pixquare"
         │
         ▼
    [existing watch-animations pipeline]
         │
         ├── export_animations.py extracts frames + metadata
         ├── Updates animations.json with timing/direction
         └── Triggers atlas rebuild
```

### Static Sprite Workflow

**Trigger:** New `.aseprite` file in `pixquare-sprites/`

```
pixquare-sprites/sword_icon.aseprite
         │
         ▼
    [watch_pixquare.py]
         │
         ├── Check: do layers "sword_icon_*" exist in auto_export_assets.aseprite?
         │
         ├── YES → Skip, notify: "sword_icon already exists, skipping"
         │
         └── NO → Merge via Aseprite CLI script:
                   │
                   ├── Open sword_icon.aseprite, get layer names
                   │   e.g., ["blade", "handle", "glow"]
                   │
                   ├── Open auto_export_assets.aseprite
                   │
                   ├── Expand canvas if sword_icon is larger (no scaling)
                   │
                   ├── Import layers as:
                   │   • sword_icon_blade
                   │   • sword_icon_handle
                   │   • sword_icon_glow
                   │
                   ├── Save auto_export_assets.aseprite
                   ├── Move original to pixquare-sprites/processed/
                   └── Notify: "Sprite 'sword_icon' merged (3 layers)"
                             │
                             ▼
                   [existing watch-sprites pipeline]
                             │
                             └── Exports layers → atlas rebuild
```

### Updating Existing Sprites

To update a previously imported sprite:
1. Delete `{filename}_*` layers manually in Aseprite
2. Re-export from Pixquare
3. Watcher will re-merge the layers

## Technical Implementation

### New Files

| File | Purpose |
|------|---------|
| `scripts/watch_pixquare.py` | Main watcher (Python + fswatch) |
| `scripts/aseprite_merge_layers.lua` | Aseprite script for layer merging |

### watch_pixquare.py

Responsibilities:
- Monitor both iCloud folders via `fswatch`
- Debounce rapid changes (2 second delay)
- Route to copy (animations) or merge (sprites)
- Move processed files to `processed/` subfolder
- Send macOS notifications via `terminal-notifier`
- Log actions for debugging

### aseprite_merge_layers.lua

Run via `aseprite -b --script`:
- Receives source file path and target file path as arguments
- Opens both files
- Checks for existing layers with prefix (returns skip signal if found)
- Expands canvas if needed (no scaling)
- Copies layers with `{filename}_{layername}` prefix
- Saves target file

### Justfile Recipes

```bash
watch-pixquare       # Start the iCloud watcher
sync-pixquare-once   # One-time sync without watching
```

## Error Handling

| Scenario | Behavior |
|----------|----------|
| iCloud folder doesn't exist | Exit with error message + setup instructions |
| File still syncing (partial) | Debounce + verify file size stable before processing |
| Aseprite not found | Exit with error (same detection as existing scripts) |
| Invalid .aseprite file | Log error, skip file, notify user |
| Layer name collision | Prefix prevents this (`sword_icon_blade` vs `dagger_blade`) |
| Same filename, different sprite | Skip-if-exists protects; delete old layers to update |
| iCloud offline | fswatch won't trigger; files sync when back online |

## Notifications

Via `terminal-notifier`:
- ✅ "Animation 'goblin_walk' synced from Pixquare"
- ✅ "Sprite 'sword_icon' merged (3 layers)"
- ⚠️ "Sprite 'sword_icon' already exists, skipping"
- ❌ "Failed to process 'broken.aseprite': [error]"

## One-Time Setup

1. Create iCloud folders:
   ```bash
   mkdir -p ~/Library/Mobile\ Documents/com~apple~CloudDocs/pixquare-animations
   mkdir -p ~/Library/Mobile\ Documents/com~apple~CloudDocs/pixquare-sprites
   ```

2. On iPad, configure Pixquare export location:
   - Files → iCloud Drive → pixquare-animations/ (for animations)
   - Files → iCloud Drive → pixquare-sprites/ (for static sprites)

## Dependencies

- Existing: `fswatch`, `aseprite` CLI, `terminal-notifier`
- No new dependencies required

## Integration Points

This pipeline feeds into existing systems without modification:
- `watch-animations` → `export_animations.py` → `animations.json`
- `watch-sprites` → `export-aseprite` → layer PNGs → TexturePacker

## Testing Checklist

- [ ] Animation: single file syncs correctly
- [ ] Animation: file overwrites existing animation
- [ ] Animation: timing/tags preserved from Pixquare
- [ ] Sprite: single-layer file merges correctly
- [ ] Sprite: multi-layer file merges with correct prefixes
- [ ] Sprite: existing layers cause skip + notification
- [ ] Sprite: canvas expands for larger sprites (no scaling)
- [ ] Processed files moved to processed/ subfolder
- [ ] Notifications appear for all actions
- [ ] Error cases handled gracefully
- [ ] Existing pipelines trigger after sync

---

*Design completed: 2026-02-03*
